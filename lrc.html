<!DOCTYPE html>
<!-- ä½¿ç”¨AIç”Ÿæˆï¼Œä¸Šä¸€å¥ å’Œ ä¸Šä¸Šå¥ éƒ½æ˜¯é‡æ–°æ ‡è®°æœ€è¿‘ä¸€ä¸ªæ ‡è®°ï¼Œåªä¸è¿‡ä»–ä»¬çš„é‡æ–°æ’­æ”¾ä½ç½®ä¸åŒï¼Œå¦‚æœæ˜¯æ‰“æ—¶é—´æˆ³æ‰“æ™šäº†ï¼Œé‚£å°±åªèƒ½ç‚¹ä¸Šä¸Šå¥ã€‚åˆ†äº«å‡ºæ¥çš„ç›®çš„ä¸»è¦æ˜¯ä¸ºäº†èŠ‚çœå¤§å®¶æ—¶é—´ï¼ˆæˆ‘è¯•ç€æ‰¾è¿‡ç½‘ä¸Šçš„åœ¨çº¿ç¼–è¾‘ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯åœŸè±†æœåŠ¡å™¨çš„åŸå› ï¼ŒéŸ³é¢‘æ–‡ä»¶ä¸Šä¼ ä¸äº†ï¼‰ã€‚å”¯ä¸€çš„é—æ†¾æ˜¯UIè¿˜æ˜¯æ²¡è®¾è®¡å¥½ï¼Œæ ‡è®°æ­Œè¯çš„æ—¶å€™ä¸èƒ½çœ‹æ³¢å½¢å›¾ï¼ˆæ³¨æ„ï¼šç‚¹ ä¸Šä¸€å¥ ä¹‹åä¼šæš‚åœæ’­æ”¾ï¼Œè€Œ ä¸Šä¸Šå¥ ä¸ä¼šï¼‰ -->
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LRCæ­Œè¯åˆ¶ä½œå·¥å…· (æ™ºèƒ½é‡æ–°æ ‡è®°ç‰ˆ)</title>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; padding: 15px; background: #f5f5f5; color: #333; line-height: 1.6; }
        .container { max-width: 100%; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 15px; color: #2c3e50; font-size: 1.5rem; }
        .control-panel { background: white; padding: 12px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 12px; }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn { 
            display: inline-block; 
            padding: 8px 10px; 
            margin: 3px; 
            background: #3498db; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            font-size: 13px; 
            cursor: pointer; 
            text-align: center; 
        }
        .btn:hover { background: #2980b9; }
        .btn-success { background: #2ecc71; }
        .btn-warning { background: #f39c12; }
        .btn-danger { background: #e74c3c; }
        .btn-info { background: #17a2b8; }
        .btn-secondary { background: #95a5a6; }
        .btn-active { background: #9b59b6; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }
        .btn-row { display: flex; flex-wrap: wrap; justify-content: center; margin: 8px 0; }
        
        /* æ³¢å½¢å›¾é«˜åº¦ */
        #waveform { 
            width: 100%; 
            height: 80px; 
            background: #ecf0f1; 
            border-radius: 5px; 
            margin: 8px 0; 
            cursor: pointer; 
        }
        
        .time-display { 
            text-align: center; 
            font-size: 1rem; 
            margin: 8px 0; 
            padding: 6px; 
            background: #2c3e50; 
            color: white; 
            border-radius: 5px; 
        }
        
        /* é€Ÿåº¦æ§åˆ¶ */
        .speed-control { 
            text-align: center; 
            margin: 6px 0; 
            font-size: 0.9rem;
        }
        .speed-btn { 
            margin: 0 2px; 
            padding: 5px 8px; 
            font-size: 12px;
        }
        
        /* æ•´åˆçš„æ­Œè¯ç¼–è¾‘åŒº */
        .lyrics-editor { 
            background: white; 
            padding: 12px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin: 12px 0;
        }
        .lyrics-editor h3 { 
            margin-bottom: 10px; 
            color: #34495e; 
            border-bottom: 2px solid #3498db; 
            padding-bottom: 5px; 
            font-size: 1.1rem; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* å½“å‰è¡Œæç¤º */
        .current-line-info {
            padding: 8px;
            background: #e1f5e9;
            border-radius: 6px;
            border-left: 4px solid #2ecc71;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }
        
        /* æ­Œè¯å’Œæ—¶é—´è½´æ•´åˆæ˜¾ç¤º */
        .lyrics-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .lyric-line {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: flex-start;
            cursor: pointer;
        }
        .lyric-line.current {
            background: #fff9e6;
            border-left: 4px solid #f39c12;
        }
        .lyric-line.marked {
            background: #e8f4fc;
            border-left: 4px solid #3498db;
        }
        .time-tag {
            color: #e74c3c;
            font-weight: bold;
            min-width: 70px;
            font-family: monospace;
            font-size: 12px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .lyric-text {
            flex-grow: 1;
            padding-top: 2px;
        }
        .lyric-line.current .lyric-text {
            color: #e67e22;
            font-weight: bold;
        }
        .lyric-line.marked .lyric-text {
            color: #2c3e50;
        }
        .lyric-line:hover {
            background: #f5f5f5;
        }
        
        /* çŠ¶æ€æç¤º */
        .status-bar { 
            margin-top: 10px; 
            padding: 8px; 
            background: #fff3cd; 
            border: 1px solid #ffeaa7; 
            border-radius: 5px; 
            color: #856404; 
            text-align: center; 
            font-size: 13px; 
        }
        .key-hint { 
            text-align: center; 
            margin-top: 8px; 
            font-size: 0.8rem; 
            color: #7f8c8d; 
        }
        
        /* æ ‡è®°æ“ä½œåŒº */
        .marking-section {
            background: white;
            padding: 12px;
            border-radius: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            margin-top: 10px;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        /* æ‰‹åŠ¨ä¸‹è½½åŒºåŸŸ */
        .manual-download-area { 
            margin: 12px auto; 
            padding: 12px; 
            background: #e8f4fc; 
            border: 2px dashed #3498db; 
            border-radius: 10px; 
            text-align: center; 
            max-width: 90%; 
            display: none; 
        }
        .copy-area { 
            margin: 8px 0; 
            padding: 8px; 
            background: #fff3cd; 
            border-radius: 5px; 
            text-align: center; 
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 767px) {
            .btn { 
                flex: 1; 
                min-width: 45%; 
                margin: 2px; 
                padding: 7px 8px;
                font-size: 12px;
            }
            .btn-row { 
                justify-content: space-between; 
            }
            h1 { font-size: 1.3rem; }
            .control-panel { padding: 10px; }
            .lyrics-editor { padding: 10px; }
            .lyrics-container { max-height: 250px; }
        }
        
        @media (min-width: 768px) {
            .lyrics-container { max-height: 350px; }
        }
        
        /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
        #audioFile {
            display: block;
            margin: 8px auto;
            padding: 8px;
            width: 100%;
            max-width: 400px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LRCæ­Œè¯åˆ¶ä½œå·¥å…· (æ™ºèƒ½é‡æ–°æ ‡è®°ç‰ˆ)</h1>
        
        <div class="control-panel">
            <input type="file" id="audioFile" accept="audio/*">
            
            <div class="time-display">
                å½“å‰æ—¶é—´: <span id="currentTime">0.00</span> ç§’ / æ€»æ—¶é•¿: <span id="totalTime">0.00</span> ç§’
            </div>
            
            <div id="waveform"></div>
            
            <div class="speed-control">
                <strong>æ’­æ”¾é€Ÿåº¦:</strong>
                <button class="btn speed-btn" id="speed05" data-speed="0.5">0.5x</button>
                <button class="btn speed-btn" id="speed075" data-speed="0.75">0.75x</button>
                <button class="btn speed-btn btn-active" id="speed10" data-speed="1.0">1.0x</button>
            </div>
            
            <div class="btn-row">
                <button class="btn" id="playPauseBtn">æ’­æ”¾/æš‚åœ</button>
                <button class="btn btn-warning" id="prevBtn">ä¸Šä¸€å¥</button>
                <button class="btn btn-success" id="markTimeBtn">æ ‡è®°æœ¬å¥</button>
                <button class="btn btn-secondary" id="jumpToPrevPrevBtn">ä¸Šä¸Šå¥</button>
                <button class="btn btn-danger" id="resetBtn">é‡ç½®</button>
                <button class="btn" id="exportBtn">å¯¼å‡ºLRC</button>
            </div>
        </div>
        
        <!-- æ•´åˆçš„æ­Œè¯ç¼–è¾‘åŒº -->
        <div class="lyrics-editor">
            <h3>
                <span>æ­Œè¯ç¼–è¾‘ä¸æ ‡è®°</span>
                <span style="font-size: 0.9rem; color: #666;">
                    è¿›åº¦: <span id="currentLineIndex">0</span>/<span id="totalLines">0</span>
                </span>
            </h3>
            
            <!-- å½“å‰è¡Œæç¤º -->
            <div class="current-line-info">
                <strong>å½“å‰æ ‡è®°è¡Œ (<span id="currentLineNumber">0</span>):</strong>
                <span id="currentLineText" style="color: #2ecc71; font-weight: bold; margin-left: 5px;">ç­‰å¾…è¾“å…¥æ­Œè¯...</span>
            </div>
            
            <div class="lyrics-container" id="lyricsContainer">
                <div style="padding: 20px; text-align: center; color: #999;">
                    è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ­Œè¯ï¼Œæ¯è¡Œä¸€å¥
                </div>
            </div>
            
            <textarea id="lyricsInput" 
                      placeholder="è¯·è¾“å…¥æ­Œè¯ï¼Œæ¯è¡Œä¸€å¥ã€‚è¾“å…¥åæŒ‰ã€Œæ›´æ–°æ­Œè¯ã€æŒ‰é’®ã€‚
ä¾‹å¦‚ï¼š
ç¬¬ä¸€å¥æ­Œè¯
ç¬¬äºŒå¥æ­Œè¯
ç¬¬ä¸‰å¥æ­Œè¯
..." 
                      style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical; margin-top: 10px;"></textarea>
            
            <div class="btn-row" style="margin-top: 10px;">
                <button class="btn" id="updateLyricsBtn">æ›´æ–°æ­Œè¯</button>
                <button class="btn" id="clearLyricsBtn">æ¸…ç©ºæ­Œè¯</button>
            </div>
        </div>
        
        <!-- æ ‡è®°æ“ä½œåŒº -->
        <div class="marking-section">
            <div class="btn-row">
                <button class="btn btn-success" id="markTimeBtn2" style="flex: 2;">âœ” æ ‡è®°æœ¬å¥ (Mé”®)</button>
                <button class="btn btn-warning" id="prevBtn2">â† ä¸Šä¸€å¥ (Pé”®)</button>
                <button class="btn btn-secondary" id="jumpToPrevPrevBtn2">â†¶ ä¸Šä¸Šå¥ (Jé”®)</button>
            </div>
            <div class="key-hint">
                <strong>æç¤º:</strong> ç©ºæ ¼é”®æ’­æ”¾/æš‚åœ | Mé”®æ ‡è®° | Pé”®ä¸Šä¸€å¥ | Jé”®ä¸Šä¸Šå¥ | å¯æ‹–åŠ¨æ³¢å½¢å›¾å®šä½
            </div>
        </div>
        
        <div class="manual-download-area" id="manualDownloadArea">
            <h3>ğŸ“¥ æ‰‹åŠ¨ä¸‹è½½é“¾æ¥</h3>
            <a id="manualDownloadLink" href="#" download="æ­Œè¯.lrc" style="display: inline-block; padding: 10px 15px; background: #2ecc71; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 14px; margin: 8px 0;">
                ç‚¹æ­¤ä¸‹è½½ LRC æ–‡ä»¶
            </a>
            <p style="font-size: 13px; color: #666; margin-top: 8px;">
                <strong>æ‰‹æœºæ“ä½œæç¤º:</strong> é•¿æŒ‰ä¸Šæ–¹ç»¿è‰²æŒ‰é’®ï¼Œé€‰æ‹©"ä¸‹è½½é“¾æ¥æ–‡ä»¶"æˆ–"ä¿å­˜é“¾æ¥"ã€‚
            </p>
        </div>
        
        <div class="copy-area" id="copyArea" style="display: none;">
            <button class="btn" id="copyBtn" style="background: #9b59b6;">ğŸ“‹ å¤åˆ¶LRCå†…å®¹åˆ°å‰ªè´´æ¿</button>
            <p style="font-size: 12px; color: #666; margin-top: 5px;">å¤åˆ¶åï¼Œå¯ç²˜è´´åˆ°å¤‡å¿˜å½•ä¸­ä¿å­˜ä¸º.lrcæ–‡ä»¶</p>
        </div>
        
        <div class="status-bar" id="status">
            è¯·ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼Œç„¶åè¾“å…¥æ­Œè¯ã€‚
        </div>
    </div>

    <script>
        // åˆå§‹åŒ– Wavesurfer
        let wavesurfer = WaveSurfer.create({
            container: '#waveform',
            waveColor: '#3498db',
            progressColor: '#2ecc71',
            cursorColor: '#e74c3c',
            height: 'auto',
            responsive: true,
            barWidth: 2,
            cursorWidth: 1,
            dragToSeek: true,
        });

        // çŠ¶æ€å˜é‡
        let lyricsData = []; // å­˜å‚¨æ­Œè¯æ•°æ® {text: "", time: null, formatted: ""}
        let currentLineIndex = 0;
        let updateTimeInterval;
        let currentPlaybackRate = 1.0;

        // 1. åŠ è½½éŸ³é¢‘æ–‡ä»¶
        document.getElementById('audioFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const url = URL.createObjectURL(file);
            wavesurfer.load(url);
            document.getElementById('status').textContent = `åŠ è½½ä¸­: ${file.name}...`;
            document.getElementById('currentTime').textContent = '0.00';
            document.getElementById('totalTime').textContent = '0.00';

            // éšè—ä¹‹å‰çš„ä¸‹è½½åŒºåŸŸ
            document.getElementById('manualDownloadArea').style.display = 'none';
            document.getElementById('copyArea').style.display = 'none';

            if (updateTimeInterval) {
                clearInterval(updateTimeInterval);
            }
        });

        // 2. éŸ³é¢‘åŠ è½½å®Œæ¯•
        wavesurfer.on('ready', () => {
            const duration = wavesurfer.getDuration();
            document.getElementById('totalTime').textContent = duration.toFixed(2);
            document.getElementById('status').textContent = 'éŸ³é¢‘å·²å°±ç»ªï¼å¯ä»¥æ’­æ”¾å¹¶å¼€å§‹æ ‡è®°ã€‚';
            
            // å¼€å§‹æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
            updateTimeInterval = setInterval(updateCurrentTimeDisplay, 100);
            
            // è®¾ç½®åˆå§‹æ’­æ”¾é€Ÿåº¦
            wavesurfer.setPlaybackRate(currentPlaybackRate);
        });

        // 3. æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
        function updateCurrentTimeDisplay() {
            if (wavesurfer.getDuration() > 0) {
                const current = wavesurfer.getCurrentTime();
                document.getElementById('currentTime').textContent = current.toFixed(2);
            }
        }

        // 4. æ›´æ–°æ­Œè¯æ˜¾ç¤º
        function updateLyricsDisplay() {
            const container = document.getElementById('lyricsContainer');
            container.innerHTML = '';
            
            if (lyricsData.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ­Œè¯ï¼Œæ¯è¡Œä¸€å¥</div>';
                return;
            }
            
            lyricsData.forEach((line, index) => {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'lyric-line';
                
                if (index === currentLineIndex) {
                    lineDiv.classList.add('current');
                } else if (line.time !== null) {
                    lineDiv.classList.add('marked');
                }
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'time-tag';
                timeSpan.textContent = line.formatted || '[æœªæ ‡è®°]';
                
                const textSpan = document.createElement('span');
                textSpan.className = 'lyric-text';
                textSpan.textContent = line.text;
                
                lineDiv.appendChild(timeSpan);
                lineDiv.appendChild(textSpan);
                container.appendChild(lineDiv);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹å‡»æŸè¡Œå¯ä»¥å°†å…¶è®¾ä¸ºå½“å‰è¡Œ
                lineDiv.addEventListener('click', () => {
                    currentLineIndex = index;
                    updateLyricsDisplay();
                    updateCurrentLineDisplay();
                    
                    // å¦‚æœè¯¥è¡Œå·²æ ‡è®°ï¼Œè·³è½¬åˆ°è¯¥æ—¶é—´ç‚¹
                    if (line.time !== null) {
                        wavesurfer.seekTo(line.time / wavesurfer.getDuration());
                        wavesurfer.pause();
                    }
                });
            });
            
            // æ»šåŠ¨åˆ°å½“å‰è¡Œ
            const currentElement = container.querySelector('.lyric-line.current');
            if (currentElement) {
                currentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // 5. æ›´æ–°å½“å‰è¡Œæ˜¾ç¤º
        function updateCurrentLineDisplay() {
            document.getElementById('totalLines').textContent = lyricsData.length;
            document.getElementById('currentLineIndex').textContent = Math.min(currentLineIndex + 1, lyricsData.length);
            document.getElementById('currentLineNumber').textContent = Math.min(currentLineIndex + 1, lyricsData.length);
            
            const currentElem = document.getElementById('currentLineText');
            
            if (currentLineIndex < lyricsData.length) {
                currentElem.textContent = lyricsData[currentLineIndex].text;
                currentElem.style.color = '#2ecc71';
            } else {
                currentElem.textContent = 'æ‰€æœ‰æ­Œè¯è¡Œå·²å®Œæˆæ ‡è®°ï¼';
                currentElem.style.color = '#e74c3c';
            }
        }

        // 6. æ ¼å¼åŒ–æ—¶é—´ä¸º LRC æ ¼å¼ [mm:ss.xx]
        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = (seconds % 60).toFixed(2);
            return `[${min.toString().padStart(2, '0')}:${sec.padStart(5, '0')}]`;
        }

        // 7. æ ‡è®°å½“å‰æ—¶é—´ç‚¹ - æ ‡è®°åä¸æš‚åœï¼
        function markCurrentTime() {
            if (wavesurfer.getDuration() <= 0) {
                alert('è¯·å…ˆåŠ è½½éŸ³é¢‘æ–‡ä»¶ã€‚');
                return;
            }
            if (lyricsData.length === 0) {
                alert('è¯·å…ˆè¾“å…¥æ­Œè¯ã€‚');
                return;
            }
            if (currentLineIndex >= lyricsData.length) {
                alert('æ‰€æœ‰æ­Œè¯è¡Œéƒ½å·²æ ‡è®°å®Œæ¯•ã€‚');
                return;
            }

            const currentTime = wavesurfer.getCurrentTime();
            const timeStr = formatTime(currentTime);
            
            // æ›´æ–°å½“å‰æ­Œè¯è¡Œçš„æ—¶é—´
            lyricsData[currentLineIndex].time = currentTime;
            lyricsData[currentLineIndex].formatted = timeStr;
            
            document.getElementById('status').textContent = `å·²æ ‡è®°ç¬¬ ${currentLineIndex + 1} è¡Œ: ${timeStr}`;
            
            // æ ‡è®°åè‡ªåŠ¨å‰è¿›åˆ°ä¸‹ä¸€å¥ï¼Œä½†ä¸è¦æš‚åœï¼
            currentLineIndex++;
            
            // æ›´æ–°æ˜¾ç¤º
            updateLyricsDisplay();
            updateCurrentLineDisplay();
            
            // å¦‚æœæ‰€æœ‰æ­Œè¯éƒ½å·²æ ‡è®°ï¼Œè‡ªåŠ¨æš‚åœ
            if (currentLineIndex >= lyricsData.length) {
                wavesurfer.pause();
                document.getElementById('status').textContent = 'æ‰€æœ‰æ­Œè¯è¡Œéƒ½å·²æ ‡è®°å®Œæ¯•ï¼';
            }
        }

        // 8. æ™ºèƒ½å›é€€åˆ°ä¸Šä¸Šå¥ï¼ˆå…³é”®æ–°åŠŸèƒ½ï¼‰
        function jumpToPreviousPreviousLine() {
            if (currentLineIndex < 2) {
                alert('éœ€è¦è‡³å°‘æ ‡è®°äº†ä¸‰å¥æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚');
                return;
            }
            
            // ç›®æ ‡ï¼šå›åˆ°ä¸Šä¸Šå¥ï¼ˆå½“å‰å¥çš„å¾€å‰ä¸¤å¥ï¼‰
            // ä½†å½“å‰æ ‡è®°è¡Œè®¾ç½®ä¸ºä¸Šä¸€å¥ï¼ˆè¿™æ ·ç”¨æˆ·å¯ä»¥ä»ä¸Šä¸Šå¥å¼€å§‹å¬ï¼Œç„¶åæ ‡è®°ä¸Šä¸€å¥çš„æ­£ç¡®å¼€å§‹æ—¶é—´ï¼‰
            const targetJumpLine = currentLineIndex - 2; // ä¸Šä¸Šå¥
            const targetMarkLine = currentLineIndex - 1; // ä¸Šä¸€å¥ï¼ˆæˆ‘ä»¬è¦é‡æ–°æ ‡è®°çš„è¿™ä¸€å¥ï¼‰
            
            // æ£€æŸ¥ä¸Šä¸Šå¥æ˜¯å¦æœ‰æ ‡è®°æ—¶é—´
            let jumpTime = 0;
            if (lyricsData[targetJumpLine] && lyricsData[targetJumpLine].time !== null) {
                jumpTime = lyricsData[targetJumpLine].time;
            } else {
                // å¦‚æœä¸Šä¸Šå¥æ²¡æœ‰æ ‡è®°ï¼Œæ‰¾æ›´æ—©çš„æ ‡è®°æˆ–ä½¿ç”¨å›é€€æ—¶é—´
                for (let i = targetJumpLine - 1; i >= 0; i--) {
                    if (lyricsData[i].time !== null) {
                        jumpTime = lyricsData[i].time;
                        break;
                    }
                }
                // å¦‚æœå‰é¢éƒ½æ²¡æœ‰æ ‡è®°ï¼Œå›é€€ä¸€ä¸ªä¼°è®¡çš„æ—¶é—´ï¼ˆä¾‹å¦‚æ¯å¥å‡è®¾2ç§’ï¼‰
                jumpTime = Math.max(0, wavesurfer.getCurrentTime() - (targetJumpLine + 1) * 2);
            }
            
            // è®¾ç½®å½“å‰è¡Œä¸ºä¸Šä¸€å¥ï¼ˆå³æˆ‘ä»¬è¦é‡æ–°æ ‡è®°çš„å¥å­ï¼‰
            currentLineIndex = targetMarkLine;
            
            // è·³è½¬åˆ°ä¸Šä¸Šå¥çš„å¼€å§‹æ—¶é—´
            wavesurfer.seekTo(jumpTime / wavesurfer.getDuration());
            wavesurfer.play();
            
            // æ›´æ–°æ˜¾ç¤º
            updateLyricsDisplay();
            updateCurrentLineDisplay();
            
            document.getElementById('status').textContent = 
                `å·²è·³è½¬åˆ°ç¬¬ ${targetJumpLine + 1} å¥å¼€å§‹æ’­æ”¾ï¼Œå‡†å¤‡é‡æ–°æ ‡è®°ç¬¬ ${targetMarkLine + 1} å¥ã€‚`;
        }

        // 9. æ™ºèƒ½é‡æ–°æ ‡è®°å½“å‰å¥ï¼ˆæ¸…é™¤å½“å‰å¥æ ‡è®°å¹¶å›é€€ï¼‰
        function reMarkCurrentLine() {
            if (currentLineIndex === 0) {
                alert('ç¬¬ä¸€å¥æ— æ³•é‡æ–°æ ‡è®°ï¼Œè¯·ä½¿ç”¨"ä¸Šä¸€å¥"åŠŸèƒ½ã€‚');
                return;
            }
            
            // æ‰¾åˆ°è¦é‡æ–°æ ‡è®°çš„å¥å­ï¼ˆå½“å‰å¥æˆ–ä¸Šä¸€å¥ï¼‰
            let targetIndex = -1;
            
            // å…ˆæ£€æŸ¥å½“å‰å¥æ˜¯å¦å·²æ ‡è®°
            if (currentLineIndex < lyricsData.length && lyricsData[currentLineIndex].time !== null) {
                targetIndex = currentLineIndex;
            }
            // æ£€æŸ¥ä¸Šä¸€å¥æ˜¯å¦å·²æ ‡è®°
            else if (currentLineIndex > 0 && lyricsData[currentLineIndex - 1].time !== null) {
                targetIndex = currentLineIndex - 1;
            }
            
            if (targetIndex === -1) {
                alert('æ²¡æœ‰æ‰¾åˆ°å·²æ ‡è®°çš„å¥å­å¯ä»¥é‡æ–°æ ‡è®°ã€‚');
                return;
            }
            
            // æ¸…é™¤æ ‡è®°
            lyricsData[targetIndex].time = null;
            lyricsData[targetIndex].formatted = '';
            
            // è®¾ç½®å½“å‰è¡Œä¸ºè¦é‡æ–°æ ‡è®°çš„è¡Œ
            currentLineIndex = targetIndex;
            
            // å¯»æ‰¾å‰ä¸€å¥çš„æ ‡è®°æ—¶é—´ï¼Œç”¨äºè·³è½¬
            let jumpTime = 0;
            if (targetIndex > 0 && lyricsData[targetIndex - 1].time !== null) {
                jumpTime = lyricsData[targetIndex - 1].time;
            } else {
                // å›é€€ä¸€ä¸ªä¼°è®¡æ—¶é—´
                jumpTime = Math.max(0, wavesurfer.getCurrentTime() - 3);
            }
            
            // è·³è½¬å¹¶æ’­æ”¾
            wavesurfer.seekTo(jumpTime / wavesurfer.getDuration());
            wavesurfer.play();
            
            // æ›´æ–°æ˜¾ç¤º
            updateLyricsDisplay();
            updateCurrentLineDisplay();
            document.getElementById('status').textContent = 
                `å·²æ¸…é™¤ç¬¬ ${targetIndex + 1} å¥æ ‡è®°ï¼Œä»ç¬¬ ${targetIndex} å¥å¼€å§‹é‡æ–°æ’­æ”¾ã€‚`;
        }

        // 10. æ™ºèƒ½ä¸Šä¸€å¥åŠŸèƒ½
        function smartGoBack() {
            if (currentLineIndex === 0) {
                alert('å·²ç»æ˜¯ç¬¬ä¸€å¥äº†ï¼Œæ— æ³•å›é€€ã€‚');
                return;
            }
            
            const currentTime = wavesurfer.getCurrentTime();
            const prevIndex = currentLineIndex - 1;
            
            // å¦‚æœä¸Šä¸€å¥å·²æ ‡è®°ï¼Œä¸”å½“å‰æ—¶é—´è·ç¦»ä¸Šä¸€å¥æ ‡è®°æ—¶é—´å¾ˆè¿‘ï¼ˆè¯´æ˜æ ‡è®°æ™šäº†ï¼‰
            if (prevIndex >= 0 && lyricsData[prevIndex].time !== null) {
                const prevMarkTime = lyricsData[prevIndex].time;
                const timeDiff = currentTime - prevMarkTime;
                
                // å¦‚æœè·ç¦»ä¸Šä¸€å¥æ ‡è®°æ—¶é—´å°äº2ç§’ï¼Œè®¤ä¸ºæ˜¯æ ‡è®°æ™šäº†ï¼Œè¯¢é—®æ˜¯å¦é‡æ–°æ ‡è®°
                if (timeDiff < 2 && timeDiff > 0) {
                    if (confirm(`æ‚¨ä¼¼ä¹æ ‡è®°æ™šäº†ï¼ˆè·ç¦»ä¸Šä¸€å¥æ ‡è®°åªæœ‰${timeDiff.toFixed(1)}ç§’ï¼‰ã€‚è¦é‡æ–°æ ‡è®°ä¸Šä¸€å¥å—ï¼Ÿ`)) {
                        // æ¸…é™¤ä¸Šä¸€å¥æ ‡è®°
                        lyricsData[prevIndex].time = null;
                        lyricsData[prevIndex].formatted = '';
                        
                        // å›é€€åˆ°ä¸Šä¸€å¥
                        currentLineIndex = prevIndex;
                        
                        // å›é€€æ’­æ”¾æ—¶é—´åˆ°æ¯”åŸæ ‡è®°æ—¶é—´æ—©ä¸€ç‚¹çš„ä½ç½®
                        const rewindTo = Math.max(0, prevMarkTime - 1);
                        wavesurfer.seekTo(rewindTo / wavesurfer.getDuration());
                        wavesurfer.pause();
                        
                        updateLyricsDisplay();
                        updateCurrentLineDisplay();
                        document.getElementById('status').textContent = `å·²æ¸…é™¤ç¬¬ ${prevIndex + 1} å¥æ ‡è®°ï¼Œè¯·é‡æ–°æ ‡è®°ã€‚`;
                        return;
                    }
                }
            }
            
            // å¦åˆ™æ‰§è¡Œæ™®é€šçš„ä¸Šä¸€å¥åŠŸèƒ½
            goToPreviousLine();
        }

        // 11. æ™®é€šçš„ä¸Šä¸€å¥åŠŸèƒ½
        function goToPreviousLine() {
            if (currentLineIndex === 0) {
                alert('å·²ç»æ˜¯ç¬¬ä¸€å¥äº†ï¼Œæ— æ³•å›é€€ã€‚');
                return;
            }
            
            // å›é€€ç´¢å¼•
            currentLineIndex = Math.max(0, currentLineIndex - 1);
            
            // å¦‚æœä¸Šä¸€å¥å·²æ ‡è®°ï¼Œè·³è½¬åˆ°æ ‡è®°æ—¶é—´
            if (lyricsData[currentLineIndex].time !== null) {
                const prevTime = lyricsData[currentLineIndex].time;
                wavesurfer.seekTo(prevTime / wavesurfer.getDuration());
            }
            
            updateLyricsDisplay();
            updateCurrentLineDisplay();
            wavesurfer.pause();
            document.getElementById('status').textContent = `å·²å›é€€åˆ°ç¬¬ ${currentLineIndex + 1} å¥ï¼Œå¯ä»¥é‡æ–°æ ‡è®°ã€‚`;
        }

        // 12. å€é€Ÿæ’­æ”¾æ§åˆ¶
        function setPlaybackRate(rate) {
            currentPlaybackRate = rate;
            wavesurfer.setPlaybackRate(rate);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.speed-btn').forEach(btn => {
                if (parseFloat(btn.getAttribute('data-speed')) === rate) {
                    btn.classList.add('btn-active');
                } else {
                    btn.classList.remove('btn-active');
                }
            });
            
            document.getElementById('status').textContent = `æ’­æ”¾é€Ÿåº¦å·²è®¾ç½®ä¸º ${rate}x`;
        }

        // 13. æ›´æ–°æ­Œè¯æŒ‰é’®äº‹ä»¶
        document.getElementById('updateLyricsBtn').addEventListener('click', function() {
            const text = document.getElementById('lyricsInput').value;
            const lines = text.split('\n').filter(line => line.trim() !== '');
            
            // è½¬æ¢ç°æœ‰æ•°æ®ï¼Œä¿ç•™å·²æ ‡è®°çš„æ—¶é—´
            const newLyricsData = lines.map((line, index) => {
                // å¦‚æœå·²æœ‰æ•°æ®ä¸”ç´¢å¼•ç›¸åŒï¼Œä¿ç•™æ—¶é—´ä¿¡æ¯
                if (index < lyricsData.length && lyricsData[index].text === line) {
                    return lyricsData[index];
                }
                // å¦åˆ™åˆ›å»ºæ–°çš„æ•°æ®é¡¹
                return { text: line, time: null, formatted: '' };
            });
            
            lyricsData = newLyricsData;
            currentLineIndex = 0;
            
            updateLyricsDisplay();
            updateCurrentLineDisplay();
            document.getElementById('status').textContent = `å·²æ›´æ–°æ­Œè¯ï¼Œå…± ${lyricsData.length} å¥ã€‚`;
        });

        // 14. æ¸…ç©ºæ­Œè¯æŒ‰é’®äº‹ä»¶
        document.getElementById('clearLyricsBtn').addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ­Œè¯å—ï¼Ÿå·²æ ‡è®°çš„æ—¶é—´ç‚¹ä¹Ÿå°†è¢«æ¸…é™¤ã€‚')) {
                lyricsData = [];
                currentLineIndex = 0;
                document.getElementById('lyricsInput').value = '';
                
                updateLyricsDisplay();
                updateCurrentLineDisplay();
                document.getElementById('status').textContent = 'æ­Œè¯å·²æ¸…ç©ºã€‚';
            }
        });

        // 15. ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('playPauseBtn').addEventListener('click', () => {
            wavesurfer.playPause();
        });

        document.getElementById('markTimeBtn').addEventListener('click', markCurrentTime);
        document.getElementById('markTimeBtn2').addEventListener('click', markCurrentTime);

        document.getElementById('prevBtn').addEventListener('click', smartGoBack);
        document.getElementById('prevBtn2').addEventListener('click', smartGoBack);

        document.getElementById('jumpToPrevPrevBtn').addEventListener('click', jumpToPreviousPreviousLine);
        document.getElementById('jumpToPrevPrevBtn2').addEventListener('click', jumpToPreviousPreviousLine);

        // 16. å€é€ŸæŒ‰é’®äº‹ä»¶
        document.getElementById('speed05').addEventListener('click', () => setPlaybackRate(0.5));
        document.getElementById('speed075').addEventListener('click', () => setPlaybackRate(0.75));
        document.getElementById('speed10').addEventListener('click', () => setPlaybackRate(1.0));

        // 17. é‡ç½®æŒ‰é’®
        document.getElementById('resetBtn').addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰å·²æ ‡è®°çš„æ—¶é—´ç‚¹å—ï¼Ÿæ­Œè¯æ–‡æœ¬å°†ä¿ç•™ã€‚')) {
                lyricsData.forEach(line => {
                    line.time = null;
                    line.formatted = '';
                });
                currentLineIndex = 0;
                
                updateLyricsDisplay();
                updateCurrentLineDisplay();
                document.getElementById('manualDownloadArea').style.display = 'none';
                document.getElementById('copyArea').style.display = 'none';
                document.getElementById('status').textContent = 'æ—¶é—´è½´å·²é‡ç½®ã€‚';
            }
        });

        // 18. å¯¼å‡º LRC æ–‡ä»¶
        document.getElementById('exportBtn').addEventListener('click', () => {
            if (lyricsData.length === 0) {
                alert('è¯·å…ˆè¾“å…¥æ­Œè¯ã€‚');
                return;
            }

            const hasMarked = lyricsData.some(line => line.time !== null);
            if (!hasMarked) {
                alert('è¯·è‡³å°‘æ ‡è®°ä¸€ä¸ªæ—¶é—´ç‚¹ã€‚');
                return;
            }

            let lrcContent = '[ti:æ­Œæ›²å]\n[ar:æ­Œæ‰‹]\n[al:ä¸“è¾‘]\n[by:æœ¬å·¥å…·ç”Ÿæˆ]\n\n';
            
            // æ·»åŠ æ‰€æœ‰æ­Œè¯è¡Œ
            lyricsData.forEach(line => {
                if (line.time !== null) {
                    lrcContent += `${line.formatted}${line.text}\n`;
                } else {
                    lrcContent += `[æœªæ ‡è®°]${line.text}\n`;
                }
            });

            // æ–¹æ³•1: å°è¯•è‡ªåŠ¨ä¸‹è½½
            let autoDownloadSuccess = false;
            try {
                const blob = new Blob([lrcContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'æ­Œè¯.lrc';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // å»¶è¿Ÿé‡Šæ”¾URL
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 10000);
                
                autoDownloadSuccess = true;
                document.getElementById('status').innerHTML = 'âœ… å·²å°è¯•è‡ªåŠ¨ä¸‹è½½ï¼<br>å¦‚æœæ²¡å¼¹å‡ºä¸‹è½½ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹æ‰‹åŠ¨ä¸‹è½½é“¾æ¥ã€‚';
            } catch (error) {
                document.getElementById('status').innerHTML = 'âš ï¸ è‡ªåŠ¨ä¸‹è½½å¤±è´¥ï¼Œè¯·ä½¿ç”¨ä¸‹æ–¹æ‰‹åŠ¨ä¸‹è½½é“¾æ¥ã€‚';
            }
            
            // æ–¹æ³•2: æ˜¾ç¤ºæ‰‹åŠ¨ä¸‹è½½åŒºåŸŸ
            const manualDownloadArea = document.getElementById('manualDownloadArea');
            const manualDownloadLink = document.getElementById('manualDownloadLink');
            const copyArea = document.getElementById('copyArea');
            
            // åˆ›å»ºæ–°çš„Blobç”¨äºæ‰‹åŠ¨ä¸‹è½½
            const blob = new Blob([lrcContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            manualDownloadLink.href = url;
            manualDownloadLink.download = 'æ­Œè¯.lrc';
            
            // æ˜¾ç¤ºæ‰‹åŠ¨ä¸‹è½½åŒºåŸŸ
            manualDownloadArea.style.display = 'block';
            copyArea.style.display = 'block';
            
            // ä¿å­˜LRCå†…å®¹åˆ°å…¨å±€å˜é‡ä¾›å¤åˆ¶ä½¿ç”¨
            window.lrcContentForCopy = lrcContent;
            
            // æ»šåŠ¨åˆ°ä¸‹è½½åŒºåŸŸ
            setTimeout(() => {
                manualDownloadArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
            
            // å¦‚æœè‡ªåŠ¨ä¸‹è½½å¤±è´¥ï¼Œç»™å‡ºæ›´æ˜ç¡®çš„æç¤º
            if (!autoDownloadSuccess) {
                document.getElementById('status').innerHTML = 'ğŸ“± è¯·ä½¿ç”¨ä¸‹æ–¹ç»¿è‰²æŒ‰é’®æ‰‹åŠ¨ä¸‹è½½ã€‚<br><small>é•¿æŒ‰æŒ‰é’® â†’ é€‰æ‹©"ä¸‹è½½é“¾æ¥æ–‡ä»¶"</small>';
            }
        });

        // 19. å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
        document.getElementById('copyBtn').addEventListener('click', function() {
            if (!window.lrcContentForCopy) {
                alert('è¯·å…ˆå¯¼å‡ºLRCæ–‡ä»¶');
                return;
            }
            
            navigator.clipboard.writeText(window.lrcContentForCopy)
                .then(() => {
                    const originalText = this.textContent;
                    this.textContent = 'âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼';
                    this.style.background = '#2ecc71';
                    
                    setTimeout(() => {
                        this.textContent = originalText;
                        this.style.background = '#9b59b6';
                    }, 2000);
                    
                    document.getElementById('status').textContent = 'LRCå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ç²˜è´´åˆ°å¤‡å¿˜å½•ä¸­ä¿å­˜ã€‚';
                })
                .catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥: ', err);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶æ–‡æœ¬ã€‚');
                });
        });

        // 20. é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;

            if (e.code === 'Space') {
                e.preventDefault();
                if (wavesurfer.getDuration() <= 0) return;
                wavesurfer.playPause();
            }
            
            // Mé”®æ ‡è®°æ—¶é—´ç‚¹
            if (e.code === 'KeyM') {
                e.preventDefault();
                markCurrentTime();
            }
            
            // Pé”®ä¸Šä¸€å¥ï¼ˆæ™ºèƒ½å›é€€ï¼‰
            if (e.code === 'KeyP') {
                e.preventDefault();
                smartGoBack();
            }
            
            // Jé”®ä¸Šä¸Šå¥ï¼ˆè·³è½¬åˆ°ä¸Šä¸Šå¥ï¼‰
            if (e.code === 'KeyJ') {
                e.preventDefault();
                jumpToPreviousPreviousLine();
            }
        });

        // 21. æ³¢å½¢å›¾ç‚¹å‡»å’Œæ‹–åŠ¨
        wavesurfer.on('interaction', () => {
            // ç‚¹å‡»æ³¢å½¢å›¾æ—¶æš‚åœæ’­æ”¾ï¼Œæ–¹ä¾¿ç²¾ç¡®æ ‡è®°
            wavesurfer.pause();
        });

        // 22. é”™è¯¯å¤„ç†
        wavesurfer.on('error', (err) => {
            console.error('WaveSurfer error:', err);
            document.getElementById('status').textContent = 'åŠ è½½éŸ³é¢‘æ—¶å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚';
        });
        
        // 23. åˆå§‹åŒ–æ˜¾ç¤º
        updateCurrentLineDisplay();
    </script>
</body>
</html>